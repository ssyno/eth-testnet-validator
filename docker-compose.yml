#
# docker-compose.yml - Single-machine Ethereum validator deployment
#
# Usage:
#   mkdir -p secrets && openssl rand -hex 32 > secrets/jwtsecret
#   docker compose up -d
#
version: "3.8"

services:
  geth:
    image: ethereum/client-go:v1.16.7
    container_name: eth-geth
    restart: unless-stopped
    command:
      - --sepolia
      - --http
      - --http.addr=0.0.0.0
      - --http.api=eth,net,web3,engine
      - --http.vhosts=*
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.api=eth,net,web3
      - --authrpc.addr=0.0.0.0
      - --authrpc.vhosts=*
      - --authrpc.jwtsecret=/secrets/jwtsecret
      - --metrics
      - --metrics.addr=0.0.0.0
      - --datadir=/data
    volumes:
      - geth-data:/data
      - ./secrets/jwtsecret:/secrets/jwtsecret:ro
    ports:
      - "8545:8545"        # HTTP RPC
      - "8546:8546"        # WebSocket
      - "30303:30303"      # P2P TCP
      - "30303:30303/udp"  # P2P UDP
      - "6060:6060"        # Metrics
    networks:
      - eth-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8545"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  lighthouse-beacon:
    image: sigp/lighthouse:v8.0.1
    container_name: eth-beacon
    restart: unless-stopped
    depends_on:
      geth:
        condition: service_healthy
    entrypoint: ["/bin/sh", "/scripts/beacon-entrypoint.sh"]
    environment:
      - ENR_ADDRESS=${ENR_ADDRESS:-}
    volumes:
      - beacon-data:/data
      - ./secrets/jwtsecret:/secrets/jwtsecret:ro
      - ./scripts/beacon-entrypoint.sh:/scripts/beacon-entrypoint.sh:ro
    ports:
      - "5052:5052"        # HTTP API
      - "5054:5054"        # Metrics
      - "9000:9000"        # P2P TCP
      - "9000:9000/udp"    # P2P UDP
    networks:
      - eth-net
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:5052/eth/v1/node/syncing"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  lighthouse-validator:
    image: sigp/lighthouse:v8.0.1
    container_name: eth-validator
    restart: unless-stopped
    depends_on:
      lighthouse-beacon:
        condition: service_started
    entrypoint: ["/bin/sh", "/scripts/validator-entrypoint.sh"]
    environment:
      - FEE_RECIPIENT=${FEE_RECIPIENT:-0x0000000000000000000000000000000000000000}
      - GRAFFITI=${GRAFFITI:-eth-validator}
    volumes:
      - validator-data:/data
      - ./validator_keys:/validator_keys:ro
      - ./scripts/validator-entrypoint.sh:/scripts/validator-entrypoint.sh:ro
    ports:
      - "5064:5064"        # Metrics
    networks:
      - eth-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5064/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  geth-data:
  beacon-data:
  validator-data:

networks:
  eth-net:
